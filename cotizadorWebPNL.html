<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estimador de Costos - Proyectos Salesforce</title>
<style>
* {margin:0; padding:0; box-sizing:border-box;}
body {font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px;}
.container {max-width:1400px; margin:0 auto; background:white; border-radius:15px; box-shadow:0 20px 40px rgba(0,0,0,0.1); overflow:hidden;}
.header {background:linear-gradient(135deg,#2c3e50,#3498db); color:white; padding:20px 30px; text-align:center;}
.header h1 {font-size:2rem; margin-bottom:10px;}
.controls {padding:20px 30px; background:#f8f9fa; border-bottom:1px solid #dee2e6;}
.control-group {display:flex; gap:15px; align-items:center; flex-wrap:wrap;}
.btn {background:linear-gradient(135deg,#28a745,#20c997); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:500; transition: all 0.3s ease;}
.btn:hover {transform:translateY(-2px); box-shadow:0 5px 15px rgba(40,167,69,0.3);}
.btn-danger {background:linear-gradient(135deg,#dc3545,#e83e8c);}
.btn-danger:hover {box-shadow:0 5px 15px rgba(220,53,69,0.3);}
.table-container {padding:0 30px 30px; overflow-x:auto;}
.table {width:100%; border-collapse:collapse; margin-top:20px; background:white; border-radius:10px; overflow:hidden; box-shadow:0 5px 15px rgba(0,0,0,0.08); table-layout:auto;}
.table th {background:linear-gradient(135deg,#495057,#6c757d); color:white; padding:15px 10px; text-align:center; font-weight:600; font-size:0.9rem; position:sticky; top:0; z-index:10; min-width:80px; position:relative; resize:horizontal; overflow:auto;}
.table td {padding:12px 10px; border-bottom:1px solid #e9ecef; text-align:center; vertical-align:middle;}
.table tbody tr:hover {background-color:#f8f9fa;}
.table input, .table select {width:100%; padding:6px 8px; border:1px solid #ced4da; border-radius:4px; font-size:0.9rem;}
.table input:focus, .table select:focus {outline:none; border-color:#007bff; box-shadow:0 0 0 2px rgba(0,123,255,0.25);}
.margin-indicator {padding:6px 12px; border-radius:20px; font-weight:bold; color:white; display:inline-block;}
.margin-low {background:linear-gradient(135deg,#dc3545,#e83e8c); animation:pulse 2s infinite;}
.margin-medium {background:linear-gradient(135deg,#ffc107,#fd7e14);}
.margin-high {background:linear-gradient(135deg,#28a745,#20c997);}
@keyframes pulse {0% {opacity:1;} 50% {opacity:0.7;} 100% {opacity:1;}}
.consultant-header {background:linear-gradient(135deg,#17a2b8,#20c997) !important; min-width:120px;}
.pm-header {background:linear-gradient(135deg,#6f42c1,#e83e8c) !important;}
.warranty-header {background:linear-gradient(135deg,#fd7e14,#ffc107) !important;}
.summary-card {background:linear-gradient(135deg,#f8f9fa,#ffffff); border-radius:10px; padding:20px; margin:20px 0; box-shadow:0 5px 15px rgba(0,0,0,0.08);}
.summary-grid {display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px;}
.summary-item {text-align:center; padding:15px; background:white; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.summary-item h4 {color:#495057; margin-bottom:10px;}
.summary-item .value {font-size:1.5rem; font-weight:bold; color:#007bff;}
.delete-btn {background:#dc3545; color:white; border:none; padding:5px 8px; border-radius:4px; cursor:pointer; font-size:0.8rem;}
.delete-btn:hover {background:#c82333;}
.calculation-note {background:#e7f3ff; border:1px solid #b8daff; border-radius:8px; padding:15px; margin:20px 30px; font-size:0.9rem; color:#004085;}
.calculation-note strong {color:#002752;}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>üöÄ Estimador de Costos - Proyectos Salesforce</h1>
<p>Gesti√≥n autom√°tica de m√°rgenes y costos de consultor√≠a</p>
</div>

<div class="calculation-note">
<strong>üìä Nota sobre c√°lculo de m√°rgenes:</strong> El margen se calcula sobre el <strong>costo facturable</strong> (sin incluir garant√≠a): <strong>Precio = Costo Facturable / (1 - Margen%)</strong>
<br><strong>Costo Total Real</strong> = Costo Facturable + Costo Garant√≠a. <strong>Margen Real</strong> = (Precio - Costo Total Real) / Precio √ó 100
<br><strong>üí° Tip:</strong> Los encabezados de columna se pueden redimensionar manualmente
</div>

<div class="controls">
<div class="control-group">
<button class="btn" id="btnAddService">‚ûï Agregar Servicio</button>
<button class="btn" id="btnAddConsultant">üë• Agregar Consultor</button>
<button class="btn btn-danger" id="btnRemoveConsultant">‚ûñ Quitar Consultor</button>
<button class="btn" id="btnExport">üì§ Exportar a Excel</button>
</div>
</div>

<div class="table-container">
<table class="table" id="projectTable">
<thead>
<tr id="headerRow">
<th>Alcance Fijo</th>
<th>Servicio</th>
<th>Horas Totales</th>
<th>Margen %</th>
<th>PM/BA %<br><small>% sobre Horas Totales</small></th>
<th>Garant√≠a %<br><small>% sobre Horas Totales</small></th>
<th class="pm-header">PM/BA Horas<br><small>Tarifa: $<input type="number" id="pmRate" value="30" min="0" step="0.01"></small></th>
<th class="warranty-header">Garant√≠a Horas<br><small>No facturado</small></th>
<th class="consultant-header">Consultor 1<br><small>Tarifa: $<input type="number" class="consultant-rate" data-index="0" value="30" min="0" step="0.01"></small></th>
<th>Costo Facturable</th>
<th>Costo Garant√≠a</th>
<th>Costo Total Real</th>
<th>Precio Cliente</th>
<th>Margen $</th>
<th>Margen Real %</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<div class="summary-card">
<h3 style="text-align:center; margin-bottom:20px; color:#495057;">üìä Resumen del Proyecto</h3>
<div class="summary-grid">
<div class="summary-item"><h4>Total Horas PM/BA</h4><div class="value" id="totalPmHours">0</div></div>
<div class="summary-item"><h4>Total Horas Desarrollo</h4><div class="value" id="totalDevHours">0</div></div>
<div class="summary-item"><h4>Total Horas Garant√≠a</h4><div class="value" id="totalWarrantyHours">0</div></div>
<div class="summary-item"><h4>Total Horas</h4><div class="value" id="totalHours">0</div></div>
<div class="summary-item"><h4>Costo Facturable</h4><div class="value" id="totalBillableCost">$0</div></div>
<div class="summary-item"><h4>Costo Garant√≠a</h4><div class="value" id="totalWarrantyCost">$0</div></div>
<div class="summary-item"><h4>Costo Total Real</h4><div class="value" id="totalRealCost">$0</div></div>
<div class="summary-item"><h4>Precio Cliente</h4><div class="value" id="totalPrice">$0</div></div>
<div class="summary-item"><h4>Margen Total</h4><div class="value" id="totalMarginAmount">$0</div></div>
<div class="summary-item"><h4>Margen Real %</h4><div class="value margin-indicator" id="totalMarginPercent">0%</div></div>
</div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
var consultantCount = 1;
var serviceCount = 0;

document.getElementById('btnAddService').addEventListener('click', addService);
document.getElementById('btnAddConsultant').addEventListener('click', addConsultant);
document.getElementById('btnRemoveConsultant').addEventListener('click', removeConsultant);
document.getElementById('btnExport').addEventListener('click', exportTableToExcel);
document.getElementById('pmRate').addEventListener('change', calculateAll);

function addService(){
    serviceCount++;
    var tbody = document.getElementById('tableBody');
    var row = document.createElement('tr');
    var consultantCells = '';
    for(var i = 0; i < consultantCount; i++){
        consultantCells += '<td><input type="number" class="consultant-hours" data-consultant="' + i + '" min="0" step="0.1" placeholder="% dedicaci√≥n"></td>';
    }
    row.innerHTML = '<td><input type="checkbox" class="fixed-checkbox"></td><td><input type="text" class="service-name" value="Servicio ' + serviceCount + '"></td><td><input type="number" class="total-hours" min="0" step="0.1"></td><td><input type="number" class="margin-percent" min="0" max="100" step="1" value="30"></td><td><input type="number" class="pm-percent" min="0" max="100" step="1" value="0"></td><td><input type="number" class="warranty-percent" min="0" max="100" step="1" value="0"></td><td><input type="number" class="pm-hours" readonly></td><td><input type="number" class="warranty-hours" readonly></td>' + consultantCells + '<td class="billable-cost">$0</td><td class="warranty-cost">$0</td><td class="total-real-cost">$0</td><td class="client-price">$0</td><td class="margin-amount">$0</td><td class="margin-percent-display">0%</td><td><button class="delete-btn">üóëÔ∏è</button></td>';
    tbody.appendChild(row);
    row.querySelectorAll('input, .delete-btn').forEach(function(el){
        el.addEventListener('change', function(){ calculateRow(row); });
        if(el.classList.contains('delete-btn')){
            el.addEventListener('click', function(){ row.remove(); updateTotalsRow(); });
        }
    });
    updateTotalsRow();
}

function addConsultant(){
    consultantCount++;
    var headerRow = document.getElementById('headerRow');
    var newHeader = document.createElement('th');
    newHeader.className = 'consultant-header';
    newHeader.innerHTML = 'Consultor ' + consultantCount + '<br><small>Tarifa: $<input type="number" class="consultant-rate" data-index="' + (consultantCount - 1) + '" value="30" min="0" step="0.01"></small>';
    headerRow.insertBefore(newHeader, headerRow.children[headerRow.children.length - 7]);
    newHeader.querySelector('input').addEventListener('change', calculateAll);
    document.querySelectorAll('#tableBody tr').forEach(function(row){
        var newCell = document.createElement('td');
        newCell.innerHTML = '<input type="number" class="consultant-hours" data-consultant="' + (consultantCount - 1) + '" min="0" step="0.1" placeholder="% dedicaci√≥n">';
        row.insertBefore(newCell, row.children[row.children.length - 7]);
        newCell.querySelector('input').addEventListener('change', function(){ calculateRow(row); });
    });
    updateTotalsRow();
}

function removeConsultant(){
    if(consultantCount <= 1){ alert('Debe haber al menos un consultor'); return; }
    var headerRow = document.getElementById('headerRow');
    headerRow.removeChild(headerRow.children[8 + consultantCount - 1]);
    document.querySelectorAll('#tableBody tr').forEach(function(row){
        row.removeChild(row.children[8 + consultantCount - 1]);
    });
    consultantCount--;
    calculateAll();
}

function calculateRow(row){
    var isFixed = row.querySelector('.fixed-checkbox').checked;
    var marginInput = row.querySelector('.margin-percent');
    if(isFixed){
        row.querySelector('.total-hours').value = 0;
        row.querySelector('.total-hours').disabled = true;
        row.querySelector('.pm-percent').value = 0;
        row.querySelector('.pm-percent').disabled = true;
        row.querySelector('.warranty-percent').value = 0;
        row.querySelector('.warranty-percent').disabled = true;
        row.querySelector('.pm-hours').value = 0;
        row.querySelector('.warranty-hours').value = 0;
        row.querySelectorAll('.consultant-hours').forEach(function(input){ input.value = 0; input.disabled = true; });
        var billableCostElement = row.querySelector('.billable-cost-input');
        if (!billableCostElement) {
            var billableCostTd = row.querySelector('.billable-cost');
            billableCostTd.innerHTML = '<input type="number" class="billable-cost-input" min="0" step="0.01" placeholder="Costo del tercero">';
            billableCostTd.querySelector('input').addEventListener('change', function(){ calculateRow(row); });
        }
        var billableCost = parseFloat(row.querySelector('.billable-cost-input').value) || 0;
        var marginPct = parseFloat(marginInput.value) || 30;
        var clientPrice = billableCost / (1 - marginPct / 100);
        var marginAmount = clientPrice - billableCost;
        var realMarginPercent = (clientPrice > 0 ? (marginAmount / clientPrice * 100) : 0).toFixed(1);
        row.querySelector('.warranty-cost').textContent = '$0.00';
        row.querySelector('.total-real-cost').textContent = '$' + billableCost.toFixed(2);
        row.querySelector('.client-price').textContent = '$' + clientPrice.toFixed(2);
        row.querySelector('.margin-amount').textContent = '$' + marginAmount.toFixed(2);
        row.querySelector('.margin-percent-display').textContent = realMarginPercent + '%';
        row.dataset.pmHours = 0;
        row.dataset.warrantyHours = 0;
        row.dataset.billableCost = billableCost;
        row.dataset.warrantyCost = 0;
        row.dataset.totalRealCost = billableCost;
        row.dataset.clientPrice = clientPrice;
        row.dataset.marginAmount = marginAmount;
    } else {
        row.querySelector('.total-hours').disabled = false;
        row.querySelector('.pm-percent').disabled = false;
        row.querySelector('.warranty-percent').disabled = false;
        row.querySelectorAll('.consultant-hours').forEach(function(input){ input.disabled = false; });
        var billableCostTd = row.querySelector('.billable-cost');
        if (row.querySelector('.billable-cost-input')) {
            billableCostTd.innerHTML = '$0';
            billableCostTd.className = 'billable-cost';
        }
        var totalH = parseFloat(row.querySelector('.total-hours').value) || 0;
        var pmRate = parseFloat(document.getElementById('pmRate').value) || 0;
        var pmPercent = parseFloat(row.querySelector('.pm-percent').value) || 0;
        var warrantyPercent = parseFloat(row.querySelector('.warranty-percent').value) || 0;
        var pmH = totalH * pmPercent / 100;
        var warrantyH = totalH * warrantyPercent / 100;
        row.querySelector('.pm-hours').value = pmH.toFixed(1);
        row.querySelector('.warranty-hours').value = warrantyH.toFixed(1);
        var totalConsultantCost = 0;
        row.querySelectorAll('.consultant-hours').forEach(function(input, i){
            var dedication = parseFloat(input.value) || 0;
            var hours = totalH * dedication / 100;
            var rate = parseFloat(document.querySelector('.consultant-rate[data-index="' + i + '"]').value) || 0;
            totalConsultantCost += hours * rate;
        });
        var billableCost = pmH * pmRate + totalConsultantCost;
        var warrantyCost = 0;
        row.querySelectorAll('.consultant-hours').forEach(function(input, i){
            var dedication = parseFloat(input.value) || 0;
            var rate = parseFloat(document.querySelector('.consultant-rate[data-index="' + i + '"]').value) || 0;
            warrantyCost += warrantyH * dedication / 100 * rate;
        });
        var totalRealCost = billableCost + warrantyCost;
        var marginPct = parseFloat(marginInput.value) || 30;
        var clientPrice = billableCost / (1 - marginPct / 100);
        var marginAmount = clientPrice - totalRealCost;
        var realMarginPercent = (clientPrice > 0 ? (marginAmount / clientPrice * 100) : 0).toFixed(1);
        row.querySelector('.billable-cost').textContent = '$' + billableCost.toFixed(2);
        row.querySelector('.warranty-cost').textContent = '$' + warrantyCost.toFixed(2);
        row.querySelector('.total-real-cost').textContent = '$' + totalRealCost.toFixed(2);
        row.querySelector('.client-price').textContent = '$' + clientPrice.toFixed(2);
        row.querySelector('.margin-amount').textContent = '$' + marginAmount.toFixed(2);
        row.querySelector('.margin-percent-display').textContent = realMarginPercent + '%';
        row.dataset.pmHours = pmH;
        row.dataset.warrantyHours = warrantyH;
        row.dataset.billableCost = billableCost;
        row.dataset.warrantyCost = warrantyCost;
        row.dataset.totalRealCost = totalRealCost;
        row.dataset.clientPrice = clientPrice;
        row.dataset.marginAmount = marginAmount;
    }
    updateTotalsRow();
}

function calculateAll(){
    document.querySelectorAll('#tableBody tr').forEach(function(row){ calculateRow(row); });
}

function updateTotalsRow(){
    var totalPm = 0, totalDev = 0, totalWarranty = 0, totalHours = 0;
    var totalBillable = 0, totalWarrantyCost = 0, totalReal = 0, totalPrice = 0, totalMargin = 0;
    document.querySelectorAll('#tableBody tr').forEach(function(row){
        totalPm += parseFloat(row.dataset.pmHours) || 0;
        totalWarranty += parseFloat(row.dataset.warrantyHours) || 0;
        totalDev += parseFloat(row.querySelector('.total-hours').value) || 0;
        totalBillable += parseFloat(row.dataset.billableCost) || 0;
        totalWarrantyCost += parseFloat(row.dataset.warrantyCost) || 0;
        totalReal += parseFloat(row.dataset.totalRealCost) || 0;
        totalPrice += parseFloat(row.dataset.clientPrice) || 0;
        totalMargin += parseFloat(row.dataset.marginAmount) || 0;
    });
    totalHours = totalDev + totalPm + totalWarranty;
    var totalMarginPct = (totalPrice > 0 ? (totalMargin / totalPrice * 100) : 0).toFixed(1);
    document.getElementById('totalPmHours').textContent = totalPm.toFixed(1);
    document.getElementById('totalDevHours').textContent = totalDev.toFixed(1);
    document.getElementById('totalWarrantyHours').textContent = totalWarranty.toFixed(1);
    document.getElementById('totalHours').textContent = totalHours.toFixed(1);
    document.getElementById('totalBillableCost').textContent = '$' + totalBillable.toFixed(2);
    document.getElementById('totalWarrantyCost').textContent = '$' + totalWarrantyCost.toFixed(2);
    document.getElementById('totalRealCost').textContent = '$' + totalReal.toFixed(2);
    document.getElementById('totalPrice').textContent = '$' + totalPrice.toFixed(2);
    document.getElementById('totalMarginAmount').textContent = '$' + totalMargin.toFixed(2);
    document.getElementById('totalMarginPercent').textContent = totalMarginPct + '%';
    var indicator = document.getElementById('totalMarginPercent');
    indicator.className = 'value margin-indicator';
    if(totalMarginPct < 20) indicator.classList.add('margin-low');
    else if(totalMarginPct < 40) indicator.classList.add('margin-medium');
    else indicator.classList.add('margin-high');
}

function exportTableToExcel(){
    var wb = XLSX.utils.book_new();
    var data = [];
    var headers = ['Alcance Fijo', 'Servicio', 'Horas Totales', 'Margen %', 'PM/BA %', 'Garant√≠a %', 'PM/BA Horas', 'Garant√≠a Horas'];
    for(var i = 0; i < consultantCount; i++){ headers.push('Consultor ' + (i + 1) + ' %'); }
    headers.push('Costo Facturable', 'Costo Garant√≠a', 'Costo Total Real', 'Precio Cliente', 'Margen $', 'Margen Real %');
    data.push(headers);
    document.querySelectorAll('#tableBody tr').forEach(function(row){
        var rowData = [
            row.querySelector('.fixed-checkbox').checked ? 'S√≠' : 'No',
            row.querySelector('.service-name').value,
            parseFloat(row.querySelector('.total-hours').value) || 0,
            parseFloat(row.querySelector('.margin-percent').value) || 0,
            parseFloat(row.querySelector('.pm-percent').value) || 0,
            parseFloat(row.querySelector('.warranty-percent').value) || 0,
            parseFloat(row.querySelector('.pm-hours').value) || 0,
            parseFloat(row.querySelector('.warranty-hours').value) || 0
        ];
        row.querySelectorAll('.consultant-hours').forEach(function(input){ rowData.push(parseFloat(input.value) || 0); });
        var bc = row.querySelector('.billable-cost-input');
        rowData.push(bc ? parseFloat(bc.value) || 0 : parseFloat(row.dataset.billableCost) || 0);
        rowData.push(parseFloat(row.dataset.warrantyCost) || 0, parseFloat(row.dataset.totalRealCost) || 0, parseFloat(row.dataset.clientPrice) || 0, parseFloat(row.dataset.marginAmount) || 0, row.querySelector('.margin-percent-display').textContent);
        data.push(rowData);
    });
    var totals = ['', 'TOTALES', parseFloat(document.getElementById('totalDevHours').textContent), '', '', '', parseFloat(document.getElementById('totalPmHours').textContent), parseFloat(document.getElementById('totalWarrantyHours').textContent)];
    for(var i = 0; i < consultantCount; i++){ totals.push(''); }
    totals.push(parseFloat(document.getElementById('totalBillableCost').textContent.replace('$', '')), parseFloat(document.getElementById('totalWarrantyCost').textContent.replace('$', '')), parseFloat(document.getElementById('totalRealCost').textContent.replace('$', '')), parseFloat(document.getElementById('totalPrice').textContent.replace('$', '')), parseFloat(document.getElementById('totalMarginAmount').textContent.replace('$', '')), document.getElementById('totalMarginPercent').textContent);
    data.push(totals);
    var ws = XLSX.utils.aoa_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, 'Estimacion');
    XLSX.writeFile(wb, 'Estimador_Proyecto_Salesforce.xlsx');
}
</script>
</body>
</html>
